ARG SEED_STAGE_BASE_IMAGE

# Multistage:
#
# 1. Bootc Build stage: builds the bootc binary and creates a tarball
# ^ This stage will be removed once a recent enough version of bootc is included in RHCOS
#
# 2. Seed stage: Based on the SEED_STAGE_BASE_IMAGE parameter (set to osImageURL in the
# cluster's machineconfig by LCA). Contains all the seed files. Copies the
# bootc tarball from the bootc build stage and installs it so we'll actually
# have the bootc binary in the final image. This installation part will also be
# removed once the first stage is removed

############ TODO: Temporary stage that builds bootc until we get the new bootc version in RHCOS
FROM quay.io/centos/centos:stream9 as bootcbuild
# This must be here unfortunately, remember to move it down when this stage is removed
RUN dnf install git zstd -y
RUN git clone https://github.com/bootc-dev/bootc /build
WORKDIR /build
RUN git checkout 2a51c5c4d578a41afa0dfeda0869bf46225ee549
RUN ./hack/build.sh
RUN mkdir -p /build/target/dev-rootfs
RUN make test-bin-archive && mkdir -p /out && cp /build/target/bootc.tar.zst /out

############ Seed stage
FROM ${SEED_STAGE_BASE_IMAGE}

# Copy all the seed files generated by LCA to the image
COPY . /usr/lib/openshift/seed

# TODO: Bootc needs this for some reason, didn't look into why, make sure it's actually required
RUN echo -e "[composefs]\nenabled = true" > /usr/lib/ostree/prepare-root.conf

# TODO: Install bootc, remove this when first stage is removed
RUN mkdir -p /usr/lib/bootc/install
COPY --from=bootcbuild /out/bootc.tar.zst /tmp
RUN tar -C / -xvf /tmp/bootc.tar.zst && rm -vrf /tmp/*
